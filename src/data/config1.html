<style>
    .connected {
        border: 3px solid #1Cb841;
        padding: 10px;
        position: relative;
        top: -10px;
    }
</style>

<h2 class="content-subhead">Sensor Simulator<span id="l">
        <h6 style="display:inline"><b> Loading...</b></h6>
    </span></h2>
<form class="pure-form pure-form-aligned" id='f1'>
    <fieldset>

        <div class="pure-control-group">
            <label for="rp">Refresh Period</label>
            <input type='number' id='rp' name='rp' min='0' max='65535'>
            <span class="pure-form-message-inline">seconds</span>
        </div>

        <h3 class="content-subhead">Calibration</h3>
        <div class="pure-control-group">
            <label>Calibrator</label>
            <a class="pure-button" id="calibButton" style="background: #1cb841;">Show</a>
        </div>
        <div id='calib' class='connected' style='display:none'>

            <h2 class="content-subhead">Step 1 : Thermistor simulator calibration</h2>
            <em>All buttons of this section stop the WPalaSensor refresh for 20 periods (<span
                    id="twentyRefreshPeriodDuration"></span> seconds).</em><br>
            <em>This allows you to adjust the thermistor and see the result on the stove display.</em><br>

            <br>
            <div class="pure-control-group">
                <label for="set10">Set Thermistor to 10°</label>
                <input type='button' id='set10' value='Set Thermistor to 10°'><span id='set10res'></span>
            </div>
            <div class="pure-control-group">
                <label for="set10d">Adjust to get 10.0° on stove display</label>
                <input type='button' id='set10d' value='-'><input type='button' id='set10u' value='+'>
            </div>

            <br>
            <div class="pure-control-group">
                <label for="set20">Set Thermistor to 20°</label>
                <input type='button' id='set20' value='Set Thermistor to 20°'><span id='set20res'></span>
            </div>
            <div class="pure-control-group">
                <label for="set20d">Adjust to get 20.0° on stove display</label>
                <input type='button' id='set20d' value='-'><input type='button' id='set20u' value='+'>
            </div>

            <br>
            <div class="pure-control-group">
                <label for="set30">Set Thermistor to 30°</label>
                <input type='button' id='set30' value='Set Thermistor to 30°'><span id='set30res'></span>
            </div>
            <div class="pure-control-group">
                <label for="set30d">Adjust to get 30.0° on stove display</label>
                <input type='button' id='set30d' value='-'><input type='button' id='set30u' value='+'>
            </div>

            <h2 class="content-subhead">Step 2 : calculate</h2>

            <div class="pure-control-group">
                <label for="calc">Calculate new Coeff A,B and C</label>
                <input type='button' id='calc' value='Run Calculation'>
            </div>
        </div>
        <div class="pure-control-group">
            <label for="sha">Coeff A</label>
            <input type='number' id='sha' name='sha' step="0.0000000000000001" size=30>
        </div>
        <div class="pure-control-group">
            <label for="shb">Coeff B</label>
            <input type='number' id='shb' name='shb' step="0.0000000000000001" size=30>
        </div>
        <div class="pure-control-group">
            <label for="shc">Coeff C</label>
            <input type='number' id='shc' name='shc' step="0.0000000000000001" size=30>
        </div>

        <h3 class="content-subhead">Home Automation</h3>

        <div class="pure-control-group">
            <label for="haproto">Protocol</label>
            <select id='haproto' name='haproto'>
                <option value="0">Disabled</option>
                <option value="1">HTTP</option>
                <option value="2">MQTT</option>
            </select>
        </div>


        <div id='hae' style='display:none'>

            <div class="pure-control-group">
                <label for="hatt">No Response Timeout</label>
                <input type='number' id='hatt' name='hatt' min='0' max='3601'>
                <span class="pure-form-message-inline">seconds</span>
                <span id="hatti" name="hatti" class="infotip">?</span>
            </div>

            <div class="pure-control-group" id="hattidiv" name="hattidiv" style="display:none;">
                <label></label>
                <div class="infotipdiv">
                    If no Home Automation temperature is retrieved/received within this time, local temperature sensor
                    will be used.
                </div>
            </div>

            <div id='hahe'>

                <div class="pure-control-group">
                    <label for="hahtype">Type</label>
                    <select id='hahtype' name='hahtype'>
                        <option value="0">Jeedom Virtual</option>
                        <option value="1">Fibaro</option>
                        <option value="2">Home Assistant</option>
                    </select>
                </div>

                <div class="pure-control-group">
                    <label for="hahhost">Hostname</label>
                    <input type='text' id='hahhost' name='hahhost' maxlength='64' pattern='[A-Za-z0-9-.]+' size='50'
                        placeholder="IP or DNS Name">
                    <span class="pure-form-message-inline">(Hostname should match with certificate name if SSL/TLS is
                        enabled)</span>
                </div>

                <div class="pure-control-group">
                    <label for="hahtls">SSL/TLS</label>
                    <input type='checkbox' id='hahtls' name='hahtls'>
                </div>

                <div id='hah0'>
                    <div class="pure-control-group">
                        <label for="hahjak">ApiKey</label>
                        <input type='password' id='hahjak' name='hahjak' maxlength='48' pattern='[A-Za-z0-9-.]+' size=50
                            title='APIKey from Jeedom configuration webpage'>
                    </div>
                </div>

                <div id='hah1'>
                    <div class="pure-control-group">
                        <label for="hahfuser">Username</label>
                        <input type='text' id='hahfuser' name='hahfuser' maxlength='64'>
                    </div>
                    <div class="pure-control-group">
                        <label for="hahfpass">Password</label>
                        <input type='password' id='hahfpass' name='hahfpass' maxlength='64'>
                    </div>
                </div>
                <div id='hah0-1'> <!-- common for hah0 and hah1 -->
                    <div class="pure-control-group">
                        <label for="hahtempid">Temperature Id</label>
                        <input type='number' id='hahtempid' name='hahtempid' min='0' max='65535'>
                        <span class="pure-form-message-inline">(Command Or Device Id)</span>
                    </div>
                </div>

                <div id='hah2'>
                    <div class="pure-control-group">
                        <label for="hahhallat">Long-lived Access Token</label>
                        <input type='password' id='hahhallat' name='hahhallat' maxlength='183'>
                    </div>
                    <div class="pure-control-group">
                        <label for="hahhaei">Temperature Entity Id</label>
                        <input type='text' id='hahhaei' name='hahhaei' maxlength='64'>
                        <span class="pure-form-message-inline">(like sensor.average_temperature)</span>
                    </div>
                </div>
            </div>

            <div id='hame'>

                <div class="pure-control-group">
                    <label for="hamtemptopic">Temperature Topic</label>
                    <input type='text' id='hamtemptopic' name='hamtemptopic' maxlength='64'>
                </div>
            </div>
        </div>

        <h3 class="content-subhead">WPalaControl / CBox</h3>

        <div class="pure-control-group">
            <label for="cbproto">Protocol</label>
            <select id='cbproto' name='cbproto'>
                <option value="0">Disabled</option>
                <option value="1">ConnectionBox</option>
                <option value="2">MQTT</option>
            </select>
        </div>

        <div id='cbe' style='display:none'>

            <div class="pure-control-group">
                <label for="cbtt">No Response Timeout</label>
                <input type='number' id='cbtt' name='cbtt' min='0' max='3601'>
                <span class="pure-form-message-inline">seconds</span>
                <span id="cbtti" name="cbtti" class="infotip">?</span>
            </div>

            <div class="pure-control-group" id="cbttidiv" name="cbttidiv" style="display:none;">
                <label></label>
                <div class="infotipdiv">
                    If no stove temperature is retrieved/received within this time, feedback correction will be disabled
                    until we get a new stove temperature value.
                </div>
            </div>

            <div id='cbhe'>

                <div class="pure-control-group">
                    <label for="cbhip">ConnectionBox IP</label>
                    <input type='text' id='cbhip' name='cbhip'
                        pattern='((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$'>
                </div>
            </div>

            <div id='cbme'>

                <div class="pure-control-group">
                    <label for="cbmt1topic">Stove/T1 Topic</label>
                    <input type='text' id='cbmt1topic' name='cbmt1topic' maxlength='32'>
                </div>
            </div>
        </div>

        <div id='mqtte' style='display:none'>
            <h3 class="content-subhead">MQTT</h3>

            <div class="pure-control-group">
                <label for="hamhost">Hostname</label>
                <input type='text' id='hamhost' name='hamhost' maxlength='64' pattern='[A-Za-z0-9-.]+' size='50'
                    placeholder="IP or DNS Name">
            </div>
            <div class="pure-control-group">
                <label for="hamport">Port</label>
                <input type='number' id='hamport' name='hamport' min='1' max='65535' placeholder="1883">
            </div>
            <div class="pure-control-group">
                <label for="hamu">Username</label>
                <input type='text' id='hamu' name='hamu' maxlength='32' placeholder="optional">
            </div>
            <div class="pure-control-group">
                <label for="hamp">Password</label>
                <input type='password' id='hamp' name='hamp' maxlength='64' placeholder="optional">
            </div>
            <div class="pure-control-group">
                <label for="hambt">Base Topic</label>
                <input type='text' id='hambt' name='hambt' maxlength='64'>
                <span id="hambti" name="hambti" class="infotip">?</span>
            </div>

            <div class="pure-control-group" id="hambtidiv" name="hambtidiv" style="display:none;">
                <label></label>
                <div class="infotipdiv">
                    Base Topic placeholders : <br>
                    <b>$sn$</b> : Serial Number of this device<br>
                    <b>$mac$</b> : WiFi MAC address of this device<br>
                    <b>$model$</b> : Model of this device<br>
                    Ex : DomoChip/<b>$sn$</b> or <b>$model$</b>/<b>$mac$</b>
                </div>
            </div>
            <div class="pure-control-group">
                <label for="hamhassde">Home Assistant Discovery</label>
                <input id='hamhassde' name='hamhassde' type="checkbox">
            </div>
        </div>
        <div class="pure-controls">
            <input type='submit' value='Save' class="pure-button pure-button-primary" disabled>
        </div>
    </fieldset>
</form>
<span id='r'></span>

<!-- inputs used for A,B and C Coeff calculation during calibration -->
<input type='number' id='R1' style='display:none'>
<input type='number' id='R2' style='display:none'>
<input type='number' id='R3' style='display:none'>

<script>
    //QuerySelector Prefix is added by load function to know into what element queySelector need to look for
    //var qsp = '#contentX ';

    function getSteinhartHart(R1, T1, R2, T2, R3, T3) {
        T1 = T1 + 273.15; T2 = T2 + 273.15; T3 = T3 + 273.15;

        var L1 = Math.log(R1); var L2 = Math.log(R2); var L3 = Math.log(R3);

        var Y1 = 1 / T1; var Y2 = 1 / T2; var Y3 = 1 / T3;

        var Lambda2 = (Y2 - Y1) / (L2 - L1);
        var Lambda3 = (Y3 - Y1) / (L3 - L1);

        var C = ((Lambda3 - Lambda2) / (L3 - L2)) / (L1 + L2 + L3);
        var B = Lambda2 - C * (L1 * L1 + L1 * L2 + L2 * L2);
        var A = Y1 - (B + L1 * L1 * C) * L1;
        return [A, B, C];
    }

    $(qsp + "#calibButton").addEventListener('click', function (evt) {
        evt.preventDefault();
        $(qsp + "#calibButton").text = ($(qsp + "#calib").style.display == '' ? 'Hide' : 'Show');
        $(qsp + "#calib").style.display = ($(qsp + "#calib").style.display == '' ? 'none' : '');
        $(qsp + "#twentyRefreshPeriodDuration").innerText = $(qsp + "#rp").value * 20;
    });


    $(qsp + "#set10").addEventListener('click', function () {
        post("/sdp", "{\"temperature\":10}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R1").value = data.r })
        })
    })

    $(qsp + "#set10d").addEventListener('click', function () {
        post("/sdp", "{\"up\":1}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R1").value = data.r })
        })
    })

    $(qsp + "#set10u").addEventListener('click', function () {
        post("/sdp", "{\"down\":1}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R1").value = data.r })
        })
    })

    $(qsp + "#set20").addEventListener('click', function () {
        post("/sdp", "{\"temperature\":20}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R2").value = data.r })
        })
    })

    $(qsp + "#set20d").addEventListener('click', function () {
        post("/sdp", "{\"up\":1}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R2").value = data.r })
        })
    })

    $(qsp + "#set20u").addEventListener('click', function () {
        post("/sdp", "{\"down\":1}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R2").value = data.r })
        })
    })

    $(qsp + "#set30").addEventListener('click', function () {
        post("/sdp", "{\"temperature\":30}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R3").value = data.r })
        })
    })

    $(qsp + "#set30d").addEventListener('click', function () {
        post("/sdp", "{\"up\":1}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R3").value = data.r })
        })
    })

    $(qsp + "#set30u").addEventListener('click', function () {
        post("/sdp", "{\"down\":1}", function () {
            getJSON("/gdp", function (data) { $(qsp + "#R3").value = data.r })
        })
    })

    $(qsp + "#calc").addEventListener('click', function () {
        var coeffs = getSteinhartHart($(qsp + "#R1").value, 10.0, $(qsp + "#R2").value, 20.0, $(qsp + "#R3").value, 30.0);
        $(qsp + "#sha").value = Math.round(coeffs[0] * 10000000000000000) / 10000000000000000;
        $(qsp + "#shb").value = Math.round(coeffs[1] * 10000000000000000) / 10000000000000000;
        $(qsp + "#shc").value = Math.round(coeffs[2] * 10000000000000000) / 10000000000000000;
    })

    function isMQTTSelected() {
        if ($(qsp + "#haproto").value == 2 || $(qsp + "#cbproto").value == 2) {
            $(qsp + "#mqtte").style.display = '';
        }
        else $(qsp + "#mqtte").style.display = 'none';
    }

    $(qsp + "#haproto").addEventListener('change', function () {
        switch ($(qsp + "#haproto").value) {
            case "0":
                $(qsp + "#hae").style.display = 'none';
                break;
            case "1":
                $(qsp + "#hae").style.display = '';
                $(qsp + "#hahe").style.display = '';
                $(qsp + "#hame").style.display = 'none';
                break;
            case "2":
                $(qsp + "#hae").style.display = '';
                $(qsp + "#hahe").style.display = 'none';
                $(qsp + "#hame").style.display = '';
                break;
        }
        isMQTTSelected();
    });

    $(qsp + "#hatti").addEventListener('click', function () {
        $(qsp + "#hattidiv").style.display = ($(qsp + "#hattidiv").style.display == '' ? 'none' : '');
    });

    $(qsp + "#hahtype").addEventListener('change', function () {
        switch ($(qsp + "#hahtype").value) {
            case "0":
                $(qsp + "#hah0").style.display = '';
                $(qsp + "#hah1").style.display = 'none';
                $(qsp + "#hah0-1").style.display = '';
                $(qsp + "#hah2").style.display = 'none';
                break;
            case "1":
                $(qsp + "#hah0").style.display = 'none';
                $(qsp + "#hah1").style.display = '';
                $(qsp + "#hah0-1").style.display = '';
                $(qsp + "#hah2").style.display = 'none';
                break;
            case "2":
                $(qsp + "#hah0").style.display = 'none';
                $(qsp + "#hah1").style.display = 'none';
                $(qsp + "#hah0-1").style.display = 'none';
                $(qsp + "#hah2").style.display = '';
                break;
        }
    });

    $(qsp + "#cbproto").addEventListener('change', function () {
        switch ($(qsp + "#cbproto").value) {
            case "0":
                $(qsp + "#cbe").style.display = 'none';
                break;
            case "1":
                $(qsp + "#cbe").style.display = '';
                $(qsp + "#cbhe").style.display = '';
                $(qsp + "#cbme").style.display = 'none';
                break;
            case "2":
                $(qsp + "#cbe").style.display = '';
                $(qsp + "#cbhe").style.display = 'none';
                $(qsp + "#cbme").style.display = '';
                break;
        }
        isMQTTSelected();
    });

    $(qsp + "#cbtti").addEventListener('click', function () {
        $(qsp + "#cbttidiv").style.display = ($(qsp + "#cbttidiv").style.display == '' ? 'none' : '');
    });

    $(qsp + "#hambti").addEventListener('click', function () {
        $(qsp + "#hambtidiv").style.display = ($(qsp + "#hambtidiv").style.display == '' ? 'none' : '');
    });

    $(qsp + "#f1").addEventListener('submit', function (event) {
        $(qsp + "#r").innerHTML = "Saving Configuration...";
        post("/sc" + qsp[8],
            convertFormDataToJson(new FormData($(qsp + "#f1"))),
            function () {
                $(qsp + "#f1").style.display = 'none';

                $(qsp + '#r').innerHTML = '<h3><b>Configuration saved <span style="color: green;">successfully</span>.</b></h3>This page will be reloaded in <span id="cd">5</span>sec.';
                runScript('var count=4;var cdi=setInterval(function(){if($("#cd")){$("#cd").innerText=count;if(!count){clearInterval(cdi);location.reload();}count--;}else{clearInterval(cdi);}},1000);');
            },
            function () {
                $(qsp + '#r').innerHTML = '<h3><b>Configuration <span style="color: red;">error</span>.</b></h3>';
            }
        );
        event.preventDefault();
    });

    getJSON("/gc" + qsp[8],
        function (GC) {
            for (k in GC) {
                if ($(qsp + '#' + k)) {
                    if ($(qsp + '#' + k).type != 'checkbox') $(qsp + '#' + k).value = GC[k];
                    else $(qsp + '#' + k).checked = GC[k];

                    triggerEvent($(qsp + '#' + k), 'change');
                }
            }

            $(qsp + "#f1 input[type=submit]").disabled = false;
            fadeOut($(qsp + "#l"));
        },
        function () {
            $(qsp + "#l").innerHTML = '<h6 style="display:inline;color:red;"><b> Failed</b></h6>';
        }
    );
</script>